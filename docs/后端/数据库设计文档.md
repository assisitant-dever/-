# 数据库设计文档

数据库设计文档是后端开发的核心蓝图，它通过规范数据存储结构，从根本上保障系统数据的一致性、完整性和访问性能。这份文档不仅是开发团队的协作指南，更是系统长期稳定运行的基础保障。

## 核心内容框架

数据库设计文档的主要内容可分为三个层级的模型设计与四大专项设计，共同构成完整的数据存储方案：

## 三级模型设计

### 概念数据模型（CDM）

系统核心实体及关系：

1. **User（用户）**：系统用户，拥有多个文档、模板和对话
2. **DocumentHistory（文档历史）**：用户生成的公文记录，关联到特定模板
3. **Template（模板）**：公文模板，可被多个文档使用
4. **Conversation（对话）**：用户对话，包含多条消息
5. **Message（消息）**：对话中的消息内容，属于特定对话
6. **AIModel（AI模型配置）**：用户的AI模型配置，关联到特定用户
7. **Platform（AI平台）**：AI服务平台，如OpenAI、Alibaba等
8. **Model（AI模型）**：具体的AI模型，属于特定平台

主要实体关系：
- 用户与文档：一对多
- 用户与模板：一对多
- 用户与对话：一对多
- 对话与消息：一对多
- 平台与模型：一对多
- 用户与AI模型配置：一对多

### 逻辑数据模型（LDM）

细化实体的属性、关系及约束条件：

1. **User**：id, username, password_hash, created_at, role
2. **DocumentHistory**：id, user_id, doc_type, content, filename, template_id, created_at
3. **Template**：id, user_id, filename, original_name, uploaded_at, content, status
4. **Conversation**：id, user_id, ai_model_id, created_at, updated_at, title, status
5. **Message**：id, conversation_id, role, content, docx_file, created_at
6. **AIModel**：id, model_id, user_id, api_key, base_url, created_at, updated_at
7. **Platform**：id, name, base_url, description, is_active, created_at
8. **Model**：id, name, platform_id, description, is_supported, created_at

### 物理数据模型（PDM）

将逻辑模型落地为具体数据库对象，以下是主要表结构定义：

#### users表
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    role VARCHAR(50) NOT NULL DEFAULT 'user',
    INDEX idx_username (username)
);
```

#### document_history表
```sql
CREATE TABLE document_history (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    doc_type VARCHAR(100),
    content TEXT,
    filename VARCHAR(255),
    template_id INTEGER,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (template_id) REFERENCES templates(id),
    INDEX idx_user_id (user_id)
);
```

#### templates表
```sql
CREATE TABLE templates (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    uploaded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    content TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id_status (user_id, status)
);
```

#### conversations表
```sql
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    ai_model_id INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    title VARCHAR(100),
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (ai_model_id) REFERENCES ai_models(id),
    INDEX ix_user_id_created_at (user_id, created_at)
);
```

#### messages表
```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    conversation_id INTEGER NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    docx_file VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id),
    INDEX idx_conversation_id (conversation_id)
);
```

#### platforms表
```sql
CREATE TABLE platforms (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL,
    base_url VARCHAR(255) NOT NULL,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### models表
```sql
CREATE TABLE models (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    platform_id INTEGER NOT NULL,
    description TEXT,
    is_supported BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (platform_id) REFERENCES platforms(id),
    UNIQUE KEY uk_platform_model (platform_id, name)
);
```

#### ai_models表
```sql
CREATE TABLE ai_models (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    model_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    api_key VARCHAR(255) NOT NULL,
    base_url VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (model_id) REFERENCES models(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY uk_user_model (user_id, model_id)
);
```

## 四大专项设计

### 表结构定义

详细说明每个字段的含义、数据类型、长度及约束条件：

#### 用户表（users）
| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR | 255 | UNIQUE, NOT NULL | 用户名 |
| password_hash | VARCHAR | 255 | NOT NULL | 密码哈希 |
| created_at | TIMESTAMP | - | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| role | VARCHAR | 50 | NOT NULL, DEFAULT 'user' | 用户角色 |

#### 文档历史表（document_history）
| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTO_INCREMENT | 文档ID |
| user_id | INTEGER | - | NOT NULL, FOREIGN KEY | 用户ID |
| doc_type | VARCHAR | 100 | - | 文档类型 |
| content | TEXT | - | - | 文档内容 |
| filename | VARCHAR | 255 | - | 文件名 |
| template_id | INTEGER | - | FOREIGN KEY, NULL | 模板ID |
| created_at | TIMESTAMP | - | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 索引设计

根据查询场景选择合适的索引类型：

1. **users表**：
   - 主键索引：id
   - 唯一索引：username

2. **document_history表**：
   - 主键索引：id
   - 外键索引：user_id, template_id
   - 查询优化：可考虑添加(user_id, created_at)联合索引

3. **templates表**：
   - 主键索引：id
   - 外键索引：user_id
   - 联合索引：(user_id, status)

4. **conversations表**：
   - 主键索引：id
   - 外键索引：user_id, ai_model_id
   - 联合索引：(user_id, created_at)

5. **messages表**：
   - 主键索引：id
   - 外键索引：conversation_id

6. **models表**：
   - 主键索引：id
   - 外键索引：platform_id
   - 联合唯一索引：(platform_id, name)

### 关系设计

定义实体间的关联方式：

1. **一对一关系**：暂无
2. **一对多关系**：
   - User -> DocumentHistory (user_id)
   - User -> Template (user_id)
   - User -> Conversation (user_id)
   - Conversation -> Message (conversation_id)
   - Platform -> Model (platform_id)
   - User -> AIModel (user_id)
   - Model -> AIModel (model_id)

3. **多对多关系**：暂无

### 数据字典

统一解释字段的业务含义、取值范围及默认值：

#### 状态字段说明

- **templates.status**：
  - 'active'：模板可用
  - 'inactive'：模板不可用

- **conversations.status**：
  - 'active'：对话活跃
  - 'closed'：对话已关闭

- **messages.role**：
  - 'user'：用户消息
  - 'assistant'：助手消息
  - 'system'：系统消息

- **platforms.is_active**：
  - true：平台启用
  - false：平台禁用

- **models.is_supported**：
  - true：支持该模型
  - false：不支持该模型

## 从文档到代码的落地实践

在实际项目中，数据库设计文档需直接指导代码实现。以Python项目为例，`models.py`文件通常基于文档定义具体的数据库模型（如使用SQLAlchemy ORM）和数据验证模型（如Pydantic）。

核心数据库模型包括：

- **User**：存储用户基本信息（对应用户表）
- **DocumentHistory**：记录文档修改轨迹（对应文档历史表）
- **Template**：管理系统模板数据（对应模板表）
- **Conversation**：管理用户对话（对应对话表）
- **Message**：存储对话消息（对应消息表）
- **Platform/Model**：系统支持的AI平台和模型（对应平台表和模型表）
- **AIModel**：用户的AI模型配置（对应AI模型配置表）

这些模型的字段定义、关系配置需与文档中的物理数据模型完全一致，确保设计与实现的统一性。

## 设计关键原则

### 平衡范式化与反范式化

- 过度范式化会增加查询关联次数，影响性能
- 反范式化可能导致数据冗余，增加维护成本
- 需根据业务场景灵活调整，如消息内容直接存储在messages表中，不进行进一步拆分

### 索引优化策略

- 高频查询字段优先建索引，但避免过多索引影响写入性能
- 联合索引需遵循"最左前缀原则"
- 外键字段默认建索引，优化关联查询

### 性能前瞻性

- 结合预估数据量（如百万级用户表）和访问频率（如首页热门模板查询）
- 提前规划分表分库或读写分离方案
- 大文本字段（如content）使用TEXT类型，避免影响查询性能

通过科学的数据库设计文档，开发团队能在编码阶段就规避数据冗余、查询低效等隐患，为系统后续的迭代升级奠定坚实基础。