# 接口规范文档

在后端开发中，接口规范文档就像模块间的"沟通手册"，它的核心价值在于**统一系统内部模块交互标准**，从根本上减少开发协作中的沟通成本和理解偏差。无论是业务层、数据访问层还是工具层，每个模块的"职责范围"和"对话方式"都需要通过这份文档清晰定义，避免出现"各说各话"的混乱局面。

## 核心内容：让模块"对话"有章可循

一份完整的接口规范文档通常包含六个关键部分。首先是**内部模块划分**，就像公司按职能划分部门，系统会明确业务层（处理核心逻辑）、数据访问层（与数据库交互）、工具层（提供通用功能）等模块的边界。

## 内部模块划分

系统按功能职责划分为以下核心模块：

### 1. 接口层模块

- **auth模块**：用户认证授权相关接口（auth.py）
- **api模块**：公文生成、模板管理等核心业务接口（api.py）
- **conversations模块**：对话管理相关接口（conversations.py）

### 2. 业务逻辑层模块

- **AI_client**：AI模型调用客户端（AI_client.py）
- **crud**：数据库CRUD操作（crud.py）

### 3. 数据访问层模块

- **database**：数据库连接和会话管理（database.py）
- **models**：数据模型定义（models.py）

### 4. 公共工具模块

- **utils**：通用工具函数（utils.py）
- **deps**：依赖项定义（deps.py）

## 模块间接口定义

这部分相当于"对话词典"，需详细说明接口名称、输入输出参数及返回值类型。

### 1. 接口层与业务逻辑层交互

#### API模块调用AI_client模块

**接口**：generate_text_for_user
- **输入参数**：
  - user_id: int - 用户ID
  - prompt: str - 提示文本
  - system_prompt: str - 系统提示
  - db: Session - 数据库会话
  - stream: bool - 是否流式输出
- **返回值**：生成的文本内容（流式返回时为迭代器）

#### API模块调用crud模块

**接口**：create_document_history
- **输入参数**：
  - db: Session - 数据库会话
  - user_id: int - 用户ID
  - doc_type: str - 文档类型
  - content: str - 文档内容
  - filename: str - 文件名
  - template_id: Optional[int] - 模板ID
- **返回值**：创建的DocumentHistory对象

### 2. 业务逻辑层与数据访问层交互

#### crud模块调用database模块

**接口**：get_db
- **输入参数**：无
- **返回值**：数据库会话对象（Session）

#### 各模块调用models模块

**接口**：数据模型类（如User, DocumentHistory等）
- **使用方式**：直接实例化或通过SQLAlchemy查询
- **返回值**：模型对象实例

### 3. 公共工具模块调用

#### 各模块调用utils模块

**接口**：save_uploaded_file
- **输入参数**：
  - file: UploadFile - 上传的文件
  - destination: str - 目标目录
- **返回值**：保存的文件路径（str）

## 通信协议

规定模块间通信采用的协议和方式：

### 1. 同步通信

- **适用场景**：简单数据查询、短时间处理
- **实现方式**：直接函数调用
- **示例**：api模块调用crud模块的函数

### 2. 异步通信

- **适用场景**：AI模型调用、文件处理等耗时操作
- **实现方式**：FastAPI异步函数 + run_in_threadpool
- **示例**：
  ```python
  generated_iterator: Iterator[str] = await run_in_threadpool(
      generate_text_for_user,
      user_id=current_user.id,
      prompt=prompt,
      system_prompt=base_prompt,
      db=db,
      stream=True
  )
  ```

## 数据格式

规定模块间传输的数据格式标准：

### 1. 函数参数格式

- 基本类型参数：按Python标准类型传递（int, str, bool等）
- 复杂类型参数：使用Pydantic模型或dataclass
- 数据库会话：统一使用SQLAlchemy的Session对象

### 2. 返回值格式

- 简单结果：直接返回Python基本类型
- 数据库对象：返回SQLAlchemy模型实例
- API响应：使用Pydantic模型（如MessageResponse, ConversationResponse等）
- 错误情况：抛出HTTPException异常

## 错误处理机制

统一异常类型、错误码及信息格式：

### 1. 异常类型

- **HTTPException**：API接口层异常，包含状态码和详细信息
- **ValidationError**：数据验证异常（Pydantic模型验证失败）
- **常规异常**：业务逻辑异常，需捕获并转换为HTTPException

### 2. 错误码规则

- **1XXX**：系统错误（如数据库连接失败）
- **2XXX**：业务错误（如模板不存在）
- **4XXX**：客户端错误（如参数错误）
- **5XXX**：服务器错误

### 3. 错误信息格式

错误信息需包含：
- 错误码：唯一标识错误类型
- 错误描述：简明扼要的错误原因
- 排查关键：帮助定位问题的关键信息（如"模板ID不存在：123"）

## 接口调用流程

规定同步和异步调用的流程规范：

### 1. 同步调用流程

```
调用方 → 参数验证 → 调用目标接口 → 结果处理 → 返回响应
```

**超时处理**：默认无超时控制，关键接口需手动添加超时处理

### 2. 异步调用流程

```
调用方 → 创建任务 → 异步调用目标接口 → 等待结果 → 结果处理 → 返回响应
```

**重试策略**：重要异步操作需实现重试机制，如AI模型调用失败时重试2-3次

## 实践注意事项

### 边界清晰是关键

明确每个接口的"职责边界"，避免模块间过度耦合，比如数据访问层不应直接处理业务逻辑。

### 数据格式"少即是多"

优先选择简洁高效的格式，避免冗余字段，例如用JSON时仅保留必要参数，减少传输负担。

### 错误处理"说人话"

统一错误码规则，错误信息需包含排查关键，让开发能快速定位问题。

通过这样的规范，开发团队不仅能提升协作效率，更能为系统后期维护和扩展打下基础——毕竟，一份清晰的"沟通手册"，永远是复杂系统稳定运行的前提。