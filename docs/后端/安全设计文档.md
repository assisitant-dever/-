# 安全设计文档

安全设计文档是保障系统数据安全与访问安全的核心指南，旨在通过系统化的安全策略防范常见风险。其内容需覆盖从用户认证到合规审计的全链路安全机制，同时兼顾业务实用性与性能平衡。

## 核心安全机制设计

### 1. 认证机制：身份验证的第一道防线

系统需通过多层次认证确保用户身份合法性。基础认证采用用户名密码模式，关键场景可叠加多因素认证。

#### 实现细节（auth.py）

- **密码安全**：
  - 使用passlib的bcrypt算法对密码进行哈希处理
  - 密码哈希存储在数据库中，不存储明文密码

- **JWT认证流程**：
  1. 用户通过`/auth/login`接口提交用户名密码
  2. 验证成功后生成JWT令牌，包含用户标识（sub字段）
  3. 令牌有效期设为60分钟（可通过ACCESS_TOKEN_EXPIRE_MINUTES配置）
  4. 后续请求在Authorization头中携带令牌：`Bearer {token}`

- **代码实现**：
  ```python
  def create_access_token(data: dict, expires_delta: timedelta | None = None):
      to_encode = data.copy()
      expire = datetime.utcnow() + (expires_delta or timedelta(minutes=15))
      to_encode.update({"exp": expire})
      return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
  ```

### 2. 授权策略：基于角色的权限管控

采用**RBAC（基于角色的访问控制）** 模型定义权限边界，按业务需求划分角色。

#### 角色定义

- **普通用户（user）**：默认角色，可使用系统基本功能
- **管理员（admin）**：拥有系统管理权限

#### 权限控制实现

- 在API接口中通过依赖项进行权限校验：
  ```python
  current_user = Depends(get_current_user)
  ```

- 关键操作需验证用户权限，如删除模板时验证模板所有者：
  ```python
  template = db.query(Template).filter(
      Template.id == template_id,
      Template.user_id == current_user.id
  ).first()
  ```

### 3. 数据加密方案：全链路数据保护

#### 传输加密

- 强制使用**HTTPS**协议，通过TLS/SSL加密传输通道
- 开发环境中使用HTTP，但生产环境必须启用HTTPS

#### 存储加密

- **敏感字段加密**：
  - API密钥（AIModel.api_key）使用加密存储
  - 加密算法：自定义加密函数（encrypt_api_key/decrypt_api_key）

- **代码实现**：
  ```python
  # 加密存储API密钥
  encrypted_key = encrypt_api_key(ai_model_create.api_key)
  new_ai_config = AIModel(
      user_id=current_user.id,
      model_id=model_id,
      api_key=encrypted_key,
      base_url=base_url
  )
  ```

### 4. 防攻击措施：主动防御常见威胁

针对Web应用高频攻击类型，部署以下防护策略：

| 攻击类型 | 防护措施 | 实现方式 |
|---------|---------|---------|
| XSS | 输入验证 + 输出编码 | FastAPI自动对JSON响应进行编码；模板渲染时使用安全函数 |
| CSRF | CSRF Token | 未实现专门的CSRF防护，依赖JWT认证机制 |
| SQL注入 | 参数化查询 | 使用SQLAlchemy ORM，避免原生SQL拼接 |
| 路径遍历 | 文件名严格校验 | 下载文件时验证文件名格式：`if not re.match(r'^[\w\-]+\.docx$', decoded_filename)` |
| 文件上传漏洞 | 文件类型和内容验证 | 验证文件MIME类型和扩展名，检查文件内容结构 |

#### 文件上传安全

上传模板文件时进行多重安全校验：
```python
# 验证文件类型
if not (file.content_type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
        and file.filename and file.filename.endswith(".docx")):
    raise HTTPException(status_code=400, detail="请上传正确的docx格式文件")

# 验证文件内容
try:
    doc = Document(file_path)
    template_content = "\n".join([para.text for para in doc.paragraphs])
except Exception as e:
    os.remove(file_path)
    raise HTTPException(status_code=400, detail=f"无效的docx文件：{str(e)}")
```

### 5. 安全审计：行为可追溯与风险预警

需记录关键操作日志，包括用户登录/登出、敏感数据访问等行为。

#### 日志记录内容

- 用户身份标识（user_id）
-操作时间（timestamp）
- 操作IP地址
- 操作类型（如登录、生成公文、删除模板等）
- 操作结果（成功/失败）

#### 日志实现

通过APILog模型记录API调用日志：
```python
api_log = APILog(
    user_id=current_user.id,
    endpoint=request.url.path,
    request_params=json.dumps(request.query_params),
    response=json.dumps(response.json())
)
db.add(api_log)
db.commit()
```

### 6. 合规性要求：满足法规与行业标准

根据业务范围适配合规要求：

- **数据隐私保护**：
  - 用户数据仅用于系统功能实现，不泄露给第三方
  - 提供数据删除功能，用户可删除自己的账户和数据

- **审计跟踪**：
  - 保留关键操作日志至少6个月
  - 支持审计日志查询和导出

## 落地实施注意事项

安全设计需避免"为安全而安全"，需结合业务场景平衡安全性与可用性。

### 核心原则

- 优先处理高风险模块（如支付、用户认证），低风险功能可简化措施
- 加密算法必须选用行业标准，**禁止自定义加密逻辑**
- 所有安全措施需通过性能测试，避免影响用户体验

### 安全测试重点

- **认证机制测试**：测试JWT令牌生成、验证、过期处理
- **权限边界测试**：验证越权访问是否被拒绝
- **输入验证测试**：测试特殊字符、SQL注入等攻击向量
- **文件上传测试**：测试恶意文件上传是否被拦截

通过以上设计，可在保障系统安全的同时，确保业务流畅运行与合规达标。