# 文件功能梳理

以下是对上传的10个Python文件的输入、输出和功能的详细梳理：

## 文件功能总览表

| 文件名 | 主要功能 | 输入 | 输出 |
|--------|----------|------|------|
| **AI_client.py** | 多AI平台客户端实现 | API密钥、基础URL、模型名称、提示词 | 生成的文本或流式文本片段 |
| **api.py** | API接口定义 | HTTP请求参数（如文件、表单数据） | JSON响应、文件下载、流式输出 |
| **auth.py** | 用户认证与授权 | 用户名、密码、令牌 | 访问令牌、用户信息 |
| **conversations.py** | 对话和消息管理 | 对话ID、消息内容、用户ID | 对话列表、消息详情 |
| **crud.py** | 数据库CRUD操作 | 用户信息、查询条件 | 数据库对象（如用户、文档） |
| **database.py** | 数据库配置与连接 | 数据库URL | 数据库会话、引擎 |
| **deps.py** | 依赖项提供 | 令牌、数据库会话 | 当前用户、数据库连接 |
| **main.py** | 应用入口与路由配置 | HTTP请求 | 应用响应、中间件处理 |
| **models.py** | 数据模型定义 | 无直接输入 | 数据库表结构、Pydantic模型 |
| **utils.py** | 工具函数集合 | 文件内容、模板路径 | 文件路径、处理结果 |

## 各文件详细说明

### AI_client.py
**功能**：实现多个AI平台的客户端，包括OpenAI、Qwen、Anthropic、Gemini等，支持文本生成和流式生成。

**输入**：
- API密钥（加密存储）
- 基础URL（可选，用于自定义API端点）
- 模型名称（如"gpt-3.5-turbo"、"qwen-plus"）
- 提示词（用户输入文本）
- 系统提示词（可选，定义AI角色）

**输出**：
- 生成的完整文本（同步调用）
- 流式文本片段（异步迭代器）

**核心类**：
- `BaseAIClient`：抽象基类，定义统一接口
- `OpenAIClient`、`QwenClient`等：各平台具体实现
- `AIClientFactory`：客户端工厂，根据平台名称创建实例

### api.py
**功能**：定义FastAPI接口，处理文件上传、公文生成、下载等请求。

**主要接口**：
- `/upload-template`：上传模板文件
- `/generate`：生成公文（流式输出）
- `/download/{filename}`：下载生成的DOCX文件
- `/history`：获取公文历史记录
- `/templates`：获取模板列表
- `/keys`：管理用户API密钥配置

**输入**：
- 文件上传（FormData）
- 表单参数（如文档类型、用户输入、模板ID）
- 请求头（如Authorization令牌）

**输出**：
- JSON响应（状态、数据）
- 流式文本（SSE格式）
- 文件下载（DOCX格式）

### auth.py
**功能**：用户注册、登录和认证逻辑。

**主要接口**：
- `/register`：用户注册
- `/login`：用户登录
- `get_current_user`：获取当前认证用户

**输入**：
- 用户名和密码（注册/登录）
- JWT令牌（认证）

**输出**：
- 注册成功消息
- 访问令牌（JWT）
- 当前用户对象

### conversations.py
**功能**：管理用户对话和消息记录。

**主要接口**：
- `/conversations`：获取/创建对话
- `/conversations/{conv_id}`：获取/更新/删除单个对话
- `/conversations/{conv_id}/messages`：添加消息

**输入**：
- 对话ID、标题、AI模型ID
- 消息内容、角色（user/assistant）

**输出**：
- 对话列表（含最后一条消息预览）
- 单个对话详情（含消息列表）
- 操作结果消息

### crud.py
**功能**：提供基本的数据库CRUD操作（目前仅实现用户创建）。

**主要函数**：
- `create_user`：创建新用户

**输入**：
- 数据库会话
- 用户信息（用户名、密码哈希）

**输出**：
- 创建的用户对象

### database.py
**功能**：数据库连接配置，创建引擎和会话。

**主要组件**：
- `engine`：SQLAlchemy引擎
- `SessionLocal`：数据库会话工厂
- `Base`：模型基类
- `get_db`：依赖项，提供数据库会话

**输入**：
- 环境变量（DATABASE_URL）

**输出**：
- 数据库会话
- 异步数据库会话（get_async_db）

### deps.py
**功能**：提供FastAPI依赖项，如数据库会话和当前用户。

**主要依赖项**：
- `get_db`：获取数据库会话
- `get_current_user`：验证令牌并返回当前用户

**输入**：
- JWT令牌（请求头）
- 数据库会话

**输出**：
- 当前用户对象
- 数据库会话

### main.py
**功能**：FastAPI应用入口，配置路由和中间件。

**主要配置**：
- CORS中间件（允许前端跨域请求）
- 路由注册（auth、api、conversations）
- 健康检查接口（/health）

**输入**：
- HTTP请求

**输出**：
- 应用响应
- 健康检查状态

### models.py
**功能**：定义数据库模型（SQLAlchemy）和Pydantic响应模型。

**主要模型**：
- **数据库模型**：User、DocumentHistory、Template、Platform、Model、AIModel、Conversation、Message等
- **Pydantic模型**：MessageResponse、ConversationResponse、PlatformModelResponse、AIModelResponse等

**输出**：
- 数据库表结构
- 数据验证和序列化模型

### utils.py
**功能**：提供通用工具函数。

**主要函数**：
- `save_uploaded_file`：保存上传文件
- `render_docx_from_template`：使用模板渲染DOCX
- `ai_model_to_response`：转换AIModel为Pydantic响应模型

**输入**：
- 文件对象、模板路径、AIModel对象

**输出**：
- 文件保存路径
- 渲染后的DOCX文件
- Pydantic响应模型实例